<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Descarga PDF</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
        .log { border: 1px solid #ccc; padding: 10px; margin-top: 10px; min-height: 100px; max-height: 300px; overflow-y: auto; background: #f5f5f5; font-family: monospace; white-space: pre-wrap; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>Test Descarga PDF desde GraphQL</h1>
    <button onclick="testPDF()">Descargar PDF</button>
    <div class="log" id="log"></div>

    <script>
        const logEl = document.getElementById('log');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            logEl.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        async function testPDF() {
            try {
                log('üöÄ Iniciando descarga de PDF...');

                // GraphQL query
                const query = `
                    query {
                        reportePDF(periodo: "hoy")
                    }
                `;

                log('üì§ Enviando query a GraphQL...');
                const response = await fetch('http://localhost:3002/api/graphql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query }),
                });

                log('üì• Respuesta recibida con status: ' + response.status);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                log('‚úÖ JSON parseado correctamente');

                if (data.errors) {
                    log(`‚ùå Errores en GraphQL: ${JSON.stringify(data.errors)}`, 'error');
                    return;
                }

                const pdfBase64 = data.data?.reportePDF;
                
                if (!pdfBase64) {
                    log('‚ùå No se recibi√≥ datos del PDF', 'error');
                    return;
                }

                log(`‚úÖ Base64 recibido, tama√±o: ${pdfBase64.length} caracteres`);

                // Convertir base64 a blob
                log('üîÑ Convirtiendo base64 a blob...');
                const binaryString = atob(pdfBase64);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                const blob = new Blob([bytes], { type: 'application/pdf' });
                log(`‚úÖ Blob creado, tama√±o: ${blob.size} bytes`);

                // Crear URL y descargar
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `reporte-operacional-${new Date().toISOString().split('T')[0]}.pdf`;
                
                document.body.appendChild(link);
                log('üì• Iniciando descarga...');
                link.click();
                document.body.removeChild(link);
                
                setTimeout(() => {
                    window.URL.revokeObjectURL(url);
                    log('‚úÖ PDF descargado correctamente', 'success');
                }, 100);

            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                console.error(error);
            }
        }
    </script>
</body>
</html>
