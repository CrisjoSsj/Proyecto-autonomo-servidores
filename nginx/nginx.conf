# Nginx API Gateway - Chuwue Grill
# Centraliza el acceso a todos los microservicios

upstream auth_service {
    server auth_service:8001;
}

upstream payment_service {
    server payment_service:8002;
}

upstream ai_orchestrator {
    server ai_orchestrator:8003;
}

upstream core_api {
    server core_api:8000;
}

upstream graphql {
    server graphql:3010;
}

upstream websocket {
    server websocket:3001;
}

upstream n8n {
    server n8n:5678;
}

upstream evolution_api {
    server evolution-api:8080;
}

server {
    listen 80;
    server_name localhost;

    # Logs
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # Auth Service - Autenticacion centralizada
    location /auth/ {
        proxy_pass http://auth_service/auth/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Payment Service - Pagos y webhooks
    location /payments/ {
        proxy_pass http://payment_service/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Partners - Registro y gestion de webhooks
    location /partners/ {
        proxy_pass http://payment_service/partners/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # AI Orchestrator - Chat y MCP
    location /chat/ {
        proxy_pass http://ai_orchestrator/chat/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_read_timeout 120s;  # Timeout mas largo para IA
    }

    # Core API (REST) - API principal del restaurante
    location /api/ {
        proxy_pass http://core_api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # GraphQL
    location /graphql {
        proxy_pass http://graphql/api/graphql;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # WebSocket - Notificaciones en tiempo real
    location /ws/ {
        proxy_pass http://websocket/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_read_timeout 86400;
    }

    # n8n Webhooks - Event Bus
    location /webhooks/ {
        proxy_pass http://n8n/webhook/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Evolution API - WhatsApp
    location /evolution/ {
        proxy_pass http://evolution_api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Health check
    location /health {
        return 200 '{"status": "ok", "gateway": "nginx"}';
        add_header Content-Type application/json;
    }

    # Root - Redirect to frontend
    location / {
        proxy_pass http://frontend:5173/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
