# ===========================================
# Chuwue Grill - Docker Compose
# Segundo Parcial - Arquitectura de Microservicios
# ===========================================

services:
  # ===========================================
  # Core API (REST) - API Principal
  # ===========================================
  core_api:
    build: ./backend/apirest_python
    container_name: chuwue-api
    ports:
      - "8000:8000"
    environment:
      - JWT_SECRET=${JWT_SECRET}
      - DATABASE_URL=sqlite:///./restaurant.db
    volumes:
      - core_data:/app/data
    networks:
      - chuwue-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/docs"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================
  # API Gateway - Nginx
  # ===========================================
  nginx:
    build: ./nginx
    container_name: chuwue-gateway
    ports:
      - "80:80"
    depends_on:
      - core_api
      - websocket
      - auth_service
      - payment_service
      - ai_orchestrator
      - n8n
    networks:
      - chuwue-network
    restart: unless-stopped

  # ===========================================
  # Pilar 1: Auth Service
  # ===========================================
  auth_service:
    build: ./backend/auth_service
    container_name: chuwue-auth
    ports:
      - "8001:8001"
    environment:
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-HS256}
      - ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES:-30}
      - REFRESH_TOKEN_EXPIRE_DAYS=${REFRESH_TOKEN_EXPIRE_DAYS:-7}
      - DATABASE_URL=sqlite:///./auth.db
    volumes:
      - auth_data:/app/data
    networks:
      - chuwue-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================
  # Pilar 2: Payment Service
  # ===========================================
  payment_service:
    build: ./backend/payment_service
    container_name: chuwue-payments
    ports:
      - "8002:8002"
    environment:
      - JWT_SECRET=${JWT_SECRET}
      - PAYMENT_PROVIDER=${PAYMENT_PROVIDER:-mock}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY:-}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET:-}
      - DATABASE_URL=sqlite:///./payments.db
    volumes:
      - payment_data:/app/data
    networks:
      - chuwue-network
    restart: unless-stopped

  # ===========================================
  # Pilar 3: AI Orchestrator
  # ===========================================
  ai_orchestrator:
    build: ./backend/ai_orchestrator
    container_name: chuwue-ai
    ports:
      - "8003:8003"
    environment:
      - JWT_SECRET=${JWT_SECRET}
      - LLM_PROVIDER=${LLM_PROVIDER:-groq}
      - GROQ_API_KEY=${GROQ_API_KEY}
      - GROQ_MODEL=${GROQ_MODEL:-llama-3-70b-8192}
      - GROQ_VISION_MODEL=${GROQ_VISION_MODEL:-mixtral-8x7b-32768}
      - CORE_API_URL=http://core_api:8000
      - DATABASE_URL=sqlite:///./chat.db
    volumes:
      - ai_data:/app/data
    networks:
      - chuwue-network
    restart: unless-stopped

  # ===========================================
  # Evolution API - WhatsApp
  # ===========================================
  evolution-api:
    image: atendai/evolution-api:latest
    container_name: chuwue-whatsapp
    ports:
      - "8080:8080"
    environment:
      - AUTHENTICATION_API_KEY=${EVOLUTION_API_KEY}
      - WEBHOOK_GLOBAL_URL=http://n8n:5678/webhook/whatsapp
      - WEBHOOK_GLOBAL_ENABLED=true
      - WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS=true
    volumes:
      - evolution_data:/evolution/instances
    networks:
      - chuwue-network
    restart: unless-stopped

  # ===========================================
  # Core API (REST) - Existente del P1
  # ===========================================
  # Ya está habilitado arriba ↑
  # core_api:
  #   build: ./backend/apirest_python
  #   container_name: chuwue-api
  #   ports:
  #     - "8000:8000"
  #   environment:
  #     - JWT_SECRET=${JWT_SECRET}
  #     - DATABASE_URL=sqlite:///./restaurant.db
  #   volumes:
  #     - core_data:/app/data
  #   networks:
  #     - chuwue-network
  #   restart: unless-stopped

  # ===========================================
  # GraphQL - Existente del P1
  # Disabled: Missing Dockerfile
  # ===========================================
  # graphql:
  #   build: ./backend/Graphql_tp
  #   container_name: chuwue-graphql
  #   ports:
  #     - "3010:3010"
  #   networks:
  #     - chuwue-network
  #   restart: unless-stopped

  # ===========================================
  # WebSocket - Servidor de Tiempo Real Ruby
  # ===========================================
  websocket:
    build: ./backend/websocket_ruby
    container_name: chuwue-websocket
    ports:
      - "3001:3001"
    networks:
      - chuwue-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3002/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ===========================================
  # Pilar 4: n8n Event Bus
  # ===========================================
  n8n:
    image: n8nio/n8n
    container_name: chuwue-n8n
    ports:
      - "5678:5678"
    environment:
      - N8N_BASIC_AUTH_ACTIVE=false
      - N8N_DEFAULT_USER_EMAIL=admin@chuwue.com
      - N8N_DEFAULT_USER_PASSWORD=admin123
      - N8N_HOST=localhost
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - WEBHOOK_URL=http://localhost:5678/
    volumes:
      - n8n_data:/home/node/.n8n
      - ./n8n/workflows:/home/node/.n8n/workflows
    networks:
      - chuwue-network
    restart: unless-stopped

  # ===========================================
  # Frontend - React + Vite
  # Disabled: Missing Dockerfile
  # ===========================================
  # frontend:
  #   build: ./frontend
  #   container_name: chuwue-frontend
  #   ports:
  #     - \"5173:5173\"
  #   environment:
  #     - VITE_API_URL=http://localhost:80
  #   networks:
  #     - chuwue-network
  #   restart: unless-stopped

# ===========================================
# Volumes
# ===========================================
volumes:
  core_data:
  auth_data:
  payment_data:
  ai_data:
  evolution_data:
  n8n_data:

# ===========================================
# Networks
# ===========================================
networks:
  chuwue-network:
    driver: bridge
