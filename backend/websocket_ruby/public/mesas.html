<h1>Estado de Mesas en Tiempo Real</h1>
<div>
  <button onclick="agregarMesa()">Agregar Mesa</button>
</div>
<div id="mesas"></div>

<script>
  const socket = new WebSocket("ws://localhost:8080");
  const mesasDiv = document.getElementById("mesas");
  // Ãšltimo mensaje recibido (Ãºtil para depuraciÃ³n)
  let lastMessage = null;

  // Mostrar errores al usuario en la UI
  function showError(msg) {
    let errDiv = document.getElementById('error-mesas');
    if (!errDiv) {
      errDiv = document.createElement('div');
      errDiv.id = 'error-mesas';
      errDiv.style.color = 'red';
      mesasDiv.parentNode.insertBefore(errDiv, mesasDiv);
    }
    errDiv.textContent = msg;
    console.error('Mesas error:', msg);
  }

  socket.onopen = () => {
    console.log("âœ… Conectado al WebSocket");
    // Avisar al servidor que este cliente se suscribe al canal "mesas"
    socket.send(JSON.stringify({
      channel: "mesas",
      action: "subscribed"
    }));
  };

  socket.onmessage = (event) => {
    try {
      const msg = JSON.parse(event.data);
      lastMessage = msg;
      console.log("ðŸ“© Mensaje recibido:", msg);

      if (msg.channel !== "mesas") return; // ignorar otros canales

      // Manejo de errores estructurados desde el servidor
      if (msg.message === 'error') {
        const errorText = msg.data && msg.data.error ? msg.data.error : 'Error desconocido';
        showError(errorText);
        return;
      }

      switch (msg.message) {
        case "estado_inicial":
          // proteger si no existe data o mesas
          const mesas = (msg.data && msg.data.mesas) || [];
          renderMesas(mesas);
          break;
        case "mesa_agregada":
          if (msg.data) agregarMesaVista(msg.data);
          break;
        case "mesa_eliminada":
          if (msg.data && (msg.data.id_mesa || msg.data.id)) {
            eliminarMesaVista(msg.data.id_mesa || msg.data.id);
          }
          break;
        case "mesa_actualizada":
          if (msg.data) updateMesa(msg.data);
          break;
        default:
          console.warn('AcciÃ³n de mesas desconocida:', msg.message);
      }
    } catch (err) {
      console.error('Error parseando mensaje WebSocket:', err, event.data);
      showError('Error interno al recibir datos de mesas');
    }
  };

  function agregarMesa() {
    const numero = prompt("NÃºmero de mesa:");
    const capacidad = prompt("Capacidad:");
    if (!numero || !capacidad) return;

    const payload = {
      channel: "mesas",
      action: "agregar_mesa",
      data: {
        numero: Number(numero),
        capacidad: Number(capacidad),
        estado: "libre"
      }
    };
    socket.send(JSON.stringify(payload));
  }

  function renderMesas(mesas) {
    mesasDiv.innerHTML = "";
    mesas.forEach(agregarMesaVista);
  }

  function agregarMesaVista(mesa) {
    const div = document.createElement("div");
    const estado = mesa.estado || 'desconocido';
    const numero = mesa.numero !== undefined ? mesa.numero : (mesa.id_mesa || 'N/A');
    const capacidad = mesa.capacidad !== undefined ? mesa.capacidad : 'N/A';

    div.className = `mesa ${estado}`;
    div.id = `mesa-${mesa.id_mesa || mesa.id}`;
    div.innerHTML = `
      <h3>Mesa ${numero}</h3>
      <p>Capacidad: ${capacidad}</p>
      <p>Estado: ${estado}</p>
      <button onclick="eliminarMesa(${mesa.id_mesa || mesa.id})">Eliminar</button>
    `;
    mesasDiv.appendChild(div);
  }

  function eliminarMesa(id_mesa) {
    socket.send(JSON.stringify({
      channel: "mesas",
      action: "eliminar_mesa",
      data: { id_mesa }
    }));
  }

  function eliminarMesaVista(id_mesa) {
    const div = document.getElementById(`mesa-${id_mesa}`);
    if (div) div.remove();
  }

  function updateMesa(mesa) {
    const id = mesa.id_mesa || mesa.id;
    const div = document.getElementById(`mesa-${id}`);
    if (div) {
      const estado = mesa.estado || 'desconocido';
      div.className = `mesa ${estado}`;
      // actualizar todos los campos visibles si existen
      const paras = div.querySelectorAll('p');
      if (paras.length >= 2) {
        paras[0].textContent = `Capacidad: ${mesa.capacidad !== undefined ? mesa.capacidad : paras[0].textContent.split(':')[1].trim()}`;
        paras[1].textContent = `Estado: ${estado}`;
      }
    }
  }
</script>
